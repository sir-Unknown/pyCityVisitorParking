name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  resolve_tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
      - name: Resolve release tag
        id: resolve
        run: |
          tag=$(git tag --points-at HEAD | grep -E '^v' | head -n 1 || true)
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          if [ -z "$tag" ]; then
            echo "No release tag found for this commit; skipping."
          else
            echo "Resolved release tag: $tag"
          fi

  publish:
    runs-on: ubuntu-latest
    environment: pypi
    needs: resolve_tag
    if: ${{ needs.resolve_tag.outputs.tag != '' && github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.resolve_tag.outputs.tag }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Validate tag matches package version
        run: |
          python - <<'PY'
          from pathlib import Path
          import re
          import sys
          tag = "${{ needs.resolve_tag.outputs.tag }}"
          version_file = Path("src/pycityvisitorparking/_version.py").read_text(encoding="utf-8")
          match = re.search(r'__version__\s*=\s*"([^"]+)"', version_file)
          if not match:
            print("Could not read __version__ from _version.py")
            sys.exit(1)
          version = match.group(1)
          if tag != f"v{version}":
            print(f"Tag {tag} does not match package version {version}.")
            sys.exit(1)
          print(f"Tag {tag} matches package version {version}.")
          PY

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install hatch==1.16.2 twine==6.2.0

      - name: Build
        run: |
          hatch build
          python -m twine check dist/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
